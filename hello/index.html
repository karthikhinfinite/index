<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polyglot Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;700&display=swap');
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        
        textarea::-webkit-scrollbar {
            width: 8px;
        }

        textarea::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 10px;
        }

        textarea::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }

        textarea::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1), 0 0 0 5px rgba(139, 92, 246, 0.5);
            }
        }
        
        @keyframes button-press {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        @keyframes focus-ring {
            from { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.5); }
            to { box-shadow: 0 0 0 8px rgba(139, 92, 246, 0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes blob {
            0% {
                transform: translate(0px, 0px) scale(1);
            }
            33% {
                transform: translate(30px, -50px) scale(1.1);
            }
            66% {
                transform: translate(-20px, 20px) scale(0.9);
            }
            100% {
                transform: translate(0px, 0px) scale(1);
            }
        }

        @keyframes listen-glow {
            0%, 100% { box-shadow: 0 0 0 0px rgba(139, 92, 246, 0.5); }
            50% { box-shadow: 0 0 0 5px rgba(139, 92, 246, 0.7); }
        }
        
        @keyframes key-press-glow {
            from { box-shadow: 0 0 0 0px rgba(139, 92, 246, 0.7); }
            to { box-shadow: 0 0 0 3px rgba(139, 92, 246, 0); }
        }

        @keyframes ready-glow {
            0%, 100% { box-shadow: 0 0 0 0px rgba(139, 92, 246, 0.7); }
            50% { box-shadow: 0 0 0 5px rgba(139, 92, 246, 0.7); }
        }

        @keyframes translate-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes swap-rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(180deg); }
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .animate-blob {
            animation: blob 7s infinite;
        }
        .animation-delay-2000 {
            animation-delay: 2s;
        }

        /* Applied Animations */
        #sttButton.is-recording {
            animation: pulse 1.5s infinite;
        }

        .button-click-animation {
            animation: button-press 0.3s ease-in-out;
        }

        .focus-ring-animation {
            animation: focus-ring 0.7s forwards;
        }

        .fade-in {
            animation: fadeIn 0.8s ease-out forwards;
        }

        #inputText.is-listening {
            animation: listen-glow 1.5s infinite;
        }
        
        #inputText.is-typing {
            animation: key-press-glow 0.3s forwards;
        }

        #translateButton.is-ready {
            animation: ready-glow 2s infinite;
        }
        
        .translated-text-fade-in {
            animation: translate-fade-in 0.8s ease-out forwards;
        }
        
        .swap-rotate-animation {
            animation: swap-rotate 0.5s ease-in-out;
        }
        
        .language-detecting-spin {
            animation: spin 1s linear infinite;
        }
        .translate-button-container {
            position: relative;
        }
        #detectText {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.875rem;
            color: #d1d5db; /* A light gray color */
        }

    </style>
</head>
<body class="bg-slate-900 flex items-center justify-center min-h-screen p-4">
    <div id="appContainer" class="bg-slate-800 p-8 rounded-3xl shadow-2xl max-w-4xl w-full flex flex-col lg:flex-row space-y-8 lg:space-y-0 lg:space-x-12 relative overflow-hidden fade-in text-slate-100">

        <!-- Decorative Background Gradients -->
        <div class="absolute -top-12 -left-12 w-64 h-64 bg-purple-500 rounded-full mix-blend-multiply filter blur-2xl opacity-20 animate-blob"></div>
        <div class="absolute -bottom-12 -right-12 w-64 h-64 bg-blue-500 rounded-full mix-blend-multiply filter blur-2xl opacity-20 animate-blob animation-delay-2000"></div>

        <!-- Input Section -->
        <div class="w-full lg:w-1/2 flex flex-col space-y-6 z-10">
            <h2 class="text-3xl font-extrabold text-slate-100">Source Language</h2>
            <div class="relative">
                <textarea id="inputText" class="w-full h-48 p-5 border-2 border-slate-700 rounded-2xl resize-none focus:outline-none focus:ring-4 focus:ring-purple-400 transition-all duration-300 shadow-sm text-slate-100 bg-slate-700" placeholder="Type or speak here..."></textarea>
                <!-- Language and Action Buttons Group -->
                <div class="flex items-center space-x-4 mt-4">
                    <button id="sttButton" class="flex items-center justify-center w-12 h-12 text-white bg-purple-500 rounded-full shadow-lg hover:bg-purple-600 transition-transform transform hover:scale-110" aria-label="Start Speech to Text">
                        <svg id="micIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z"></path>
                            <path fill-rule="evenodd" d="M3 10a7 7 0 0114 0v1a1 1 0 11-2 0v-1a5 5 0 00-10 0v1a1 1 0 11-2 0v-1z" clip-rule="evenodd"></path>
                        </svg>
                        <svg id="stopIcon" class="w-6 h-6 hidden" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <button id="ttsButton" class="flex items-center justify-center w-12 h-12 text-white bg-blue-500 rounded-full shadow-lg hover:bg-blue-600 transition-transform transform hover:scale-110" aria-label="Text to Speech">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L6 14.707l-2.43 2.43A1 1 0 012 16V4a1 1 0 011.707-.707L6 5.293l3.293-3.293zM14 8a1 1 0 011 1v2a1 1 0 11-2 0V9a1 1 0 011-1zm-2 2a1 1 0 011 1v2a1 1 0 11-2 0v-2a1 1 0 011-1zm4-2a1 1 0 011 1v2a1 1 0 11-2 0V9a1 1 0 011-1z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <div class="relative flex-grow">
                        <select id="sourceLanguage" class="w-full p-3 text-slate-200 bg-slate-700 border-2 border-slate-700 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all duration-200">
                            <option value="detect">Detect Language</option>
                            <option value="en" selected>English</option>
                            <option value="es">Spanish</option>
                            <option value="kn">Kannada</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="ja">Japanese</option>
                            <option value="zh">Chinese</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <button id="translateButton" class="w-full p-4 mt-6 text-lg font-bold text-white bg-gradient-to-r from-purple-500 to-blue-500 rounded-full shadow-lg hover:shadow-xl hover:from-purple-600 hover:to-blue-600 transition-all transform hover:scale-105">
                Translate
            </button>
        </div>

        <!-- Output Section -->
        <div class="w-full lg:w-1/2 flex flex-col space-y-6 z-10">
            <h2 class="text-3xl font-extrabold text-slate-100">Target Language</h2>
            <div id="loadingIndicator" class="hidden flex items-center justify-center p-5 h-48 bg-slate-700 rounded-2xl border-2 border-slate-700 text-slate-500">
                <div class="animate-spin rounded-full h-10 w-10 border-t-4 border-b-4 border-purple-500"></div>
                <span class="ml-4 text-xl font-medium">Processing...</span>
            </div>
            <textarea id="translatedText" class="w-full h-48 p-5 bg-slate-700 rounded-2xl border-2 border-slate-700 resize-none focus:outline-none shadow-sm text-slate-100" readonly placeholder="Output will appear here..."></textarea>
            
            <!-- Language and Action Buttons Group -->
            <div class="flex items-center justify-between space-x-4 mt-4">
                <button id="swapButton" class="flex-shrink-0 flex items-center justify-center w-12 h-12 text-white bg-slate-600 rounded-full shadow-lg hover:bg-slate-500 transition-transform transform hover:scale-110" aria-label="Swap languages">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M12 7a1 1 0 00-1-1H3.414l2.293-2.293a1 1 0 00-1.414-1.414l-4 4a1 1 0 000 1.414l4 4a1 1 0 001.414-1.414L3.414 8H11a1 1 0 001-1zm6.586 4H10a1 1 0 01-1-1V5.586l-2.293 2.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L16.586 7H18a1 1 0 011 1v3a1 1 0 01-1 1z" clip-rule="evenodd"></path>
                    </svg>
                </button>
                <select id="targetLanguage" class="flex-grow p-3 text-slate-200 bg-slate-700 border-2 border-slate-700 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-400 transition-all duration-200">
                    <option value="en" selected>English</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="ja">Japanese</option>
                    <option value="zh">Chinese</option>
                    <option value="kn">Kannada</option>
                </select>
                <button id="ttsTranslatedButton" class="flex items-center justify-center w-12 h-12 text-white bg-blue-500 rounded-full shadow-lg hover:bg-blue-600 transition-transform transform hover:scale-110" aria-label="Text to Speech for translated text">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L6 14.707l-2.43 2.43A1 1 0 012 16V4a1 1 0 011.707-.707L6 5.293l3.293-3.293zM14 8a1 1 0 011 1v2a1 1 0 11-2 0V9a1 1 0 011-1zm-2 2a1 1 0 011 1v2a1 1 0 11-2 0v-2a1 1 0 011-1zm4-2a1 1 0 011 1v2a1 1 0 11-2 0V9a1 1 0 011-1z" clip-rule="evenodd"></path>
                    </svg>
                </button>
                <button id="copyButton" class="flex items-center justify-center w-12 h-12 text-white bg-gray-500 rounded-full shadow-lg hover:bg-gray-600 transition-transform transform hover:scale-110" aria-label="Copy translated text">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z"></path>
                        <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2H6zm-2 3v11h8V6H6z"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // DOM element references
        const inputText = document.getElementById('inputText');
        const sttButton = document.getElementById('sttButton');
        const ttsButton = document.getElementById('ttsButton');
        const translateButton = document.getElementById('translateButton');
        const translatedText = document.getElementById('translatedText');
        const ttsTranslatedButton = document.getElementById('ttsTranslatedButton');
        const sourceLanguage = document.getElementById('sourceLanguage');
        const targetLanguage = document.getElementById('targetLanguage');
        const swapButton = document.getElementById('swapButton');
        const copyButton = document.getElementById('copyButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const micIcon = document.getElementById('micIcon');
        const stopIcon = document.getElementById('stopIcon');
        const appContainer = document.getElementById('appContainer');

        // Check for browser support
        if (!('SpeechRecognition' in window) || !('webkitSpeechRecognition' in window)) {
            sttButton.disabled = true;
            sttButton.title = 'Speech to Text not supported by this browser.';
        }
        if (!('SpeechSynthesis' in window)) {
            ttsButton.disabled = true;
            ttsTranslatedButton.disabled = true;
            ttsButton.title = 'Text to Speech not supported by this browser.';
        }
        
        // Function to handle button click animation
        const animateClick = (button) => {
            button.classList.add('button-click-animation');
            setTimeout(() => {
                button.classList.remove('button-click-animation');
            }, 300);
        };

        // Speech-to-Text setup
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = false;
        let isRecording = false;
        
        // Set the recognition language based on the source language dropdown
        recognition.lang = sourceLanguage.value;
        sourceLanguage.addEventListener('change', () => {
            recognition.lang = sourceLanguage.value === 'detect' ? 'en' : sourceLanguage.value;
            updateTranslateButtonText();
        });

        sttButton.addEventListener('click', () => {
            animateClick(sttButton);
            if (isRecording) {
                recognition.stop();
                isRecording = false;
                micIcon.classList.remove('hidden');
                stopIcon.classList.add('hidden');
                sttButton.classList.remove('is-recording');
                inputText.classList.remove('is-listening');
            } else {
                recognition.start();
                isRecording = true;
                micIcon.classList.add('hidden');
                stopIcon.classList.remove('hidden');
                sttButton.classList.add('is-recording');
                inputText.classList.add('is-listening');
            }
        });

        recognition.onresult = (event) => {
            const transcript = event.results[event.results.length - 1][0].transcript;
            inputText.value = transcript;
        };

        recognition.onend = () => {
            isRecording = false;
            micIcon.classList.remove('hidden');
            stopIcon.classList.add('hidden');
            sttButton.classList.remove('is-recording');
            inputText.classList.remove('is-listening');
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            isRecording = false;
            micIcon.classList.remove('hidden');
            stopIcon.classList.add('hidden');
            sttButton.classList.remove('is-recording');
            inputText.classList.remove('is-listening');
        };
        
        // Function to detect language using Gemini API
        const detectLanguage = async (text) => {
            if (!text) {
                return 'en';
            }
            
            const prompt = `Detect the language of the following text and provide only the two-letter language code (e.g., 'en', 'es', 'kn', 'fr'): "${text}"`;
            const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.statusText}`);
                }

                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const detectedCode = result.candidates[0].content.parts[0].text.trim().toLowerCase().slice(0, 2);
                    return detectedCode;
                }
            } catch (error) {
                console.error('Error detecting language:', error);
            }
            return 'en';
        };

        // Event listener for manual keyboard input animation
        let typingTimeout;
        inputText.addEventListener('keydown', () => {
            clearTimeout(typingTimeout);
            inputText.classList.add('is-typing');
        });
        inputText.addEventListener('keyup', () => {
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                inputText.classList.remove('is-typing');
            }, 300);
        });

        // Add a ready animation to the 'Translate' button when there is text
        inputText.addEventListener('input', () => {
            if (inputText.value.trim() !== '') {
                translateButton.classList.add('is-ready');
            } else {
                translateButton.classList.remove('is-ready');
            }
            updateTranslateButtonText();
        });
        
        function updateTranslateButtonText() {
            if (sourceLanguage.value === 'detect') {
                translateButton.textContent = 'Detect and Translate';
            } else {
                translateButton.textContent = 'Translate';
            }
        }
        updateTranslateButtonText();

        // Swap button functionality
        swapButton.addEventListener('click', () => {
            animateClick(swapButton);
            swapButton.classList.add('swap-rotate-animation');
            
            const tempLang = sourceLanguage.value;
            const tempText = inputText.value;

            sourceLanguage.value = targetLanguage.value;
            targetLanguage.value = tempLang;

            inputText.value = translatedText.value;
            translatedText.value = tempText;

            setTimeout(() => {
                swapButton.classList.remove('swap-rotate-animation');
            }, 500);
            updateTranslateButtonText();
        });
        
        // Copy button functionality
        copyButton.addEventListener('click', () => {
            animateClick(copyButton);
            translatedText.select();
            document.execCommand('copy');
        });

        // Text-to-Speech setup
        const speakText = (text, lang) => {
            if (text === '') return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            window.speechSynthesis.speak(utterance);
        };
        
        ttsButton.addEventListener('click', () => {
            animateClick(ttsButton);
            speakText(inputText.value, sourceLanguage.value);
        });

        ttsTranslatedButton.addEventListener('click', () => {
            animateClick(ttsTranslatedButton);
            speakText(translatedText.value, targetLanguage.value);
        });

        // Add button press animation to translate button
        translateButton.addEventListener('click', async () => {
            animateClick(translateButton);
            let sourceLang = sourceLanguage.value;
            const textToTranslate = inputText.value;
            const targetLang = targetLanguage.value;

            if (textToTranslate) {
                if (sourceLang === 'detect') {
                    sourceLang = await detectLanguage(textToTranslate);
                    sourceLanguage.value = sourceLang; // Update the dropdown
                }
                translateText(textToTranslate, sourceLang, targetLang);
            } else {
                translatedText.value = "Please enter some text to translate.";
            }
        });
        
        // Allow Enter key to trigger translation
        inputText.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                translateButton.click();
            }
        });

        // Add focus animation to textareas
        inputText.addEventListener('focus', () => {
            inputText.classList.add('focus-ring-animation');
        });
        inputText.addEventListener('blur', () => {
            inputText.classList.remove('focus-ring-animation');
        });
        translatedText.addEventListener('focus', () => {
            translatedText.classList.add('focus-ring-animation');
        });
        translatedText.addEventListener('blur', () => {
            translatedText.classList.remove('focus-ring-animation');
        });

        // Translation function with exponential backoff
        const translateText = async (text, sourceLang, targetLang) => {
            loadingIndicator.classList.remove('hidden');
            translatedText.value = '';
            translatedText.classList.remove('translated-text-fade-in');

            let retries = 0;
            const maxRetries = 5;
            const baseDelay = 1000;

            const makeApiCall = async () => {
                const prompt = `Provide the text from ${getLanguageName(sourceLang)} in ${getLanguageName(targetLang)}: "${text}"`;
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && retries < maxRetries) {
                        const delay = baseDelay * Math.pow(2, retries);
                        console.warn(`API rate limit exceeded. Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        retries++;
                        return makeApiCall(); // Retry the call
                    }
                    if (!response.ok) {
                        throw new Error(`API error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const translation = result.candidates[0].content.parts[0].text;
                        translatedText.value = translation.replace(/\*\*/g, '');
                        translatedText.classList.add('translated-text-fade-in');
                    } else {
                        translatedText.value = "Translation failed. Could not get a valid response.";
                        console.error("API response was not as expected:", result);
                    }
                } catch (error) {
                    console.error('Error during API call:', error);
                    translatedText.value = `An error occurred: ${error.message}`;
                } finally {
                    loadingIndicator.classList.add('hidden');
                }
            };
            await makeApiCall();
        };

        const getLanguageName = (langCode) => {
            const languages = {
                'en': 'English', 'es': 'Spanish', 'fr': 'French',
                'de': 'German', 'ja': 'Japanese', 'zh': 'Chinese',
                'kn': 'Kannada',
                'detect': 'Detect Language'
            };
            return languages[langCode] || langCode;
        };
        
        // Ensure the fade-in animation runs on load
        window.addEventListener('load', () => {
            appContainer.style.opacity = '1';
            appContainer.style.transform = 'translateY(0)';
        });
    </script>
</body>
</html>
